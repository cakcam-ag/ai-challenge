<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Day 7 ‚Äî Dialogue Compression</title>
<style>
  body {
    background: #111;
    color: #eee;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
  }
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }
  h1 {
    margin: 0 0 4px 0;
    color: #4caf50;
  }
  .subtitle {
    margin: 0 0 16px 0;
    color: #aaa;
    font-size: 0.9rem;
  }
  .chat {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
  }
  .chat-window {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 12px;
    height: 480px;
    overflow-y: auto;
    border: 1px solid #333;
  }
  .msg {
    margin-bottom: 12px;
    padding: 8px 10px;
    border-radius: 6px;
    max-width: 80%;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .msg.user {
    background: #0d47a1;
    margin-left: auto;
  }
  .msg.assistant {
    background: #263238;
    margin-right: auto;
  }
  .msg.system {
    background: #424242;
    margin-left: auto;
    margin-right: auto;
    text-align: center;
    font-size: 0.8rem;
  }
  .input-area {
    margin-top: 16px;
  }
  textarea {
    width: 100%;
    height: 80px;
    background: #1e1e1e;
    color: #fff;
    border: 1px solid #333;
    border-radius: 6px;
    padding: 8px;
    box-sizing: border-box;
    resize: vertical;
    font-family: inherit;
  }
  button {
    margin-top: 8px;
    padding: 10px 18px;
    border-radius: 6px;
    border: none;
    background: #0e6efd;
    color: #fff;
    font-size: 0.95rem;
    cursor: pointer;
  }
  button:hover {
    background: #0c5bd4;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  .sidebar {
    background: #1e1e1e;
    border-radius: 8px;
    padding: 12px;
    border: 1px solid #333;
    font-size: 0.9rem;
  }
  .metric {
    margin-bottom: 8px;
  }
  .metric span.label {
    color: #aaa;
  }
  .metric span.value {
    font-weight: bold;
    color: #4caf50;
  }
  .summary-box {
    margin-top: 12px;
    padding: 8px;
    border-radius: 6px;
    background: #263238;
    font-size: 0.85rem;
    white-space: pre-wrap;
    word-wrap: break-word;
  }
  .summary-box strong {
    color: #4caf50;
  }
  .summary-box.ok {
    border-left: 3px solid #4caf50;
  }
  .top-actions {
    margin-top: 8px;
    display: flex;
    gap: 8px;
  }
  .top-actions button {
    flex: 0 0 auto;
  }
  hr {
    border: none;
    border-top: 1px solid #333;
    margin: 12px 0;
  }
  .savings {
    color: #4caf50;
    font-weight: bold;
  }
</style>
</head>
<body>
<div class="container">
  <h1>ü§è Day 7 ‚Äî Dialogue Compression</h1>
  <p class="subtitle">
    Chat with the agent and watch how conversation history is summarized every 10 messages.
    The model uses <strong>compressed history</strong> instead of sending everything.
    Compare token usage: full history vs compressed.
  </p>

  <div class="chat">
    <div>
      <div class="chat-window" id="chatWindow">
        <div class="msg system">Conversation started. Type a message below.</div>
      </div>

      <div class="input-area">
        <textarea id="userInput" placeholder="Say something..."></textarea>
        <button id="sendBtn" onclick="sendMessage()">Send</button>
        <div class="top-actions">
          <button onclick="resetConversation()">Reset Conversation</button>
        </div>
      </div>
    </div>

    <div class="sidebar">
      <h3>Token & Compression Info</h3>
      <div class="metric">
        <span class="label">Estimated tokens (full history): </span>
        <span class="value" id="fullTokens">‚Äì</span>
      </div>
      <div class="metric">
        <span class="label">Estimated tokens (compressed): </span>
        <span class="value" id="compressedTokens">‚Äì</span>
      </div>
      <div class="metric">
        <span class="label">Token savings: </span>
        <span class="value savings" id="savings">‚Äì</span>
      </div>
      <hr />
      <div class="metric">
        <span class="label">API prompt tokens: </span>
        <span class="value" id="apiPrompt">‚Äì</span>
      </div>
      <div class="metric">
        <span class="label">API completion tokens: </span>
        <span class="value" id="apiCompletion">‚Äì</span>
      </div>
      <div class="metric">
        <span class="label">API total tokens: </span>
        <span class="value" id="apiTotal">‚Äì</span>
      </div>

      <hr />

      <div class="metric">
        <span class="label">Raw history messages: </span>
        <span class="value" id="rawLen">0</span>
      </div>
      <div class="metric">
        <span class="label">Pending (unsummarized) messages: </span>
        <span class="value" id="pendingLen">0</span>
      </div>
      <div class="metric">
        <span class="label">Summaries stored: </span>
        <span class="value" id="summariesCount">0</span>
      </div>
      <div class="metric">
        <span class="label">Messages per summary block: </span>
        <span class="value" id="blockSize">10</span>
      </div>

      <div id="summaryBox" class="summary-box" style="display:none;"></div>
    </div>
  </div>
</div>

<script>
let chatWindow = document.getElementById("chatWindow");
let userInput = document.getElementById("userInput");
let sendBtn = document.getElementById("sendBtn");

function appendMessage(role, text) {
  const div = document.createElement("div");
  div.classList.add("msg", role);
  div.textContent = text;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

async function sendMessage() {
  const text = userInput.value.trim();
  if (!text) return;

  appendMessage("user", text);
  userInput.value = "";
  userInput.focus();

  sendBtn.disabled = true;
  sendBtn.textContent = "Sending...";

  try {
    const resp = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text }),
    });

    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status}`);
    }

    const data = await resp.json();

    if (data.error) {
      appendMessage("assistant", "‚ùå Error: " + data.error);
    } else {
      appendMessage("assistant", data.reply);

      // Token metrics
      const t = data.token_usage || {};
      document.getElementById("fullTokens").textContent =
        t.full_context_tokens_est?.toLocaleString() ?? "‚Äì";
      document.getElementById("compressedTokens").textContent =
        t.compressed_context_tokens_est?.toLocaleString() ?? "‚Äì";
      
      const savings = t.savings_percent ?? 0;
      if (savings > 0) {
        document.getElementById("savings").textContent = savings + "%";
      } else {
        document.getElementById("savings").textContent = "‚Äì";
      }
      
      document.getElementById("apiPrompt").textContent =
        t.api_prompt_tokens?.toLocaleString() ?? "‚Äì";
      document.getElementById("apiCompletion").textContent =
        t.api_completion_tokens?.toLocaleString() ?? "‚Äì";
      document.getElementById("apiTotal").textContent =
        t.api_total_tokens?.toLocaleString() ?? "‚Äì";

      // State
      const s = data.state || {};
      document.getElementById("rawLen").textContent =
        s.raw_history_length ?? 0;
      document.getElementById("pendingLen").textContent =
        s.pending_messages_length ?? 0;
      document.getElementById("summariesCount").textContent =
        s.summaries_count ?? 0;
      document.getElementById("blockSize").textContent =
        s.summary_block_size ?? 10;

      // Summary info
      const box = document.getElementById("summaryBox");
      if (s.summary_created) {
        box.style.display = "block";
        box.className = "summary-box ok";
        box.innerHTML =
          "<strong>üìù New summary created!</strong>\n\n" +
          (s.last_summary || "(no text)");
      } else if (s.summaries_count > 0) {
        box.style.display = "block";
        box.className = "summary-box";
        box.innerHTML =
          "Conversation has been summarized " +
          s.summaries_count +
          " time(s). New summaries will appear here when created.";
      } else {
        box.style.display = "none";
      }
    }
  } catch (err) {
    appendMessage("assistant", "‚ùå Error: " + err.message);
  } finally {
    sendBtn.disabled = false;
    sendBtn.textContent = "Send";
  }
}

async function resetConversation() {
  try {
    await fetch("/reset", { method: "POST" });
    chatWindow.innerHTML = "";
    appendMessage("system", "Conversation reset. Start again!");
    document.getElementById("fullTokens").textContent = "‚Äì";
    document.getElementById("compressedTokens").textContent = "‚Äì";
    document.getElementById("savings").textContent = "‚Äì";
    document.getElementById("apiPrompt").textContent = "‚Äì";
    document.getElementById("apiCompletion").textContent = "‚Äì";
    document.getElementById("apiTotal").textContent = "‚Äì";
    document.getElementById("rawLen").textContent = "0";
    document.getElementById("pendingLen").textContent = "0";
    document.getElementById("summariesCount").textContent = "0";
    document.getElementById("summaryBox").style.display = "none";
  } catch (err) {
    appendMessage("assistant", "‚ùå Error resetting: " + err.message);
  }
}

// allow Enter to send (Shift+Enter for newline)
userInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});
</script>
</body>
</html>

